import sys
from importlib.machinery import ModuleSpec, PathFinder
from importlib.machinery import all_suffixes as module_suffixes
from importlib.util import spec_from_file_location
from itertools import chain
from pathlib import Path

MAPPING = {'evennia': 'D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia'}
NAMESPACES = {'evennia.game_template': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template'], 'evennia.locale': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale'], 'evennia.commands._trial_temp': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\commands\\_trial_temp'], 'evennia.contrib.full_systems.evscaperoom.states': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\contrib\\full_systems\\evscaperoom\\states'], 'evennia.game_template.server.logs': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\server\\logs'], 'evennia.game_template.web.static': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static'], 'evennia.game_template.web.templates': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\templates'], 'evennia.game_template.web.static.rest_framework': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\rest_framework'], 'evennia.game_template.web.static.webclient': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\webclient'], 'evennia.game_template.web.static.website': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\website'], 'evennia.game_template.web.static.rest_framework.css': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\rest_framework\\css'], 'evennia.game_template.web.static.rest_framework.images': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\rest_framework\\images'], 'evennia.game_template.web.static.webclient.css': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\webclient\\css'], 'evennia.game_template.web.static.webclient.js': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\webclient\\js'], 'evennia.game_template.web.static.website.css': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\website\\css'], 'evennia.game_template.web.static.website.images': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\static\\website\\images'], 'evennia.game_template.web.templates.rest_framework': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\templates\\rest_framework'], 'evennia.game_template.web.templates.webclient': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\templates\\webclient'], 'evennia.game_template.web.templates.website': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\templates\\website'], 'evennia.game_template.web.templates.website.flatpages': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\templates\\website\\flatpages'], 'evennia.game_template.web.templates.website.registration': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\game_template\\web\\templates\\website\\registration'], 'evennia.locale.de': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\de'], 'evennia.locale.es': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\es'], 'evennia.locale.fr': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\fr'], 'evennia.locale.it': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\it'], 'evennia.locale.ko': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\ko'], 'evennia.locale.la': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\la'], 'evennia.locale.pl': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\pl'], 'evennia.locale.pt': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\pt'], 'evennia.locale.ru': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\ru'], 'evennia.locale.sv': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\sv'], 'evennia.locale.zh': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\zh'], 'evennia.locale.de.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\de\\LC_MESSAGES'], 'evennia.locale.es.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\es\\LC_MESSAGES'], 'evennia.locale.fr.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\fr\\LC_MESSAGES'], 'evennia.locale.it.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\it\\LC_MESSAGES'], 'evennia.locale.ko.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\ko\\LC_MESSAGES'], 'evennia.locale.la.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\la\\LC_MESSAGES'], 'evennia.locale.pl.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\pl\\LC_MESSAGES'], 'evennia.locale.pt.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\pt\\LC_MESSAGES'], 'evennia.locale.ru.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\ru\\LC_MESSAGES'], 'evennia.locale.sv.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\sv\\LC_MESSAGES'], 'evennia.locale.zh.LC_MESSAGES': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\locale\\zh\\LC_MESSAGES'], 'evennia.web.static': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static'], 'evennia.web.templates': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates'], 'evennia.web.static.rest_framework': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\rest_framework'], 'evennia.web.static.webclient': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\webclient'], 'evennia.web.static.website': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\website'], 'evennia.web.static.rest_framework.css': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\rest_framework\\css'], 'evennia.web.static.rest_framework.images': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\rest_framework\\images'], 'evennia.web.static.webclient.css': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\webclient\\css'], 'evennia.web.static.webclient.fonts': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\webclient\\fonts'], 'evennia.web.static.webclient.js': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\webclient\\js'], 'evennia.web.static.webclient.media': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\webclient\\media'], 'evennia.web.static.webclient.js.plugins': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\webclient\\js\\plugins'], 'evennia.web.static.website.css': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\website\\css'], 'evennia.web.static.website.images': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\static\\website\\images'], 'evennia.web.templates.admin': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates\\admin'], 'evennia.web.templates.rest_framework': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates\\rest_framework'], 'evennia.web.templates.webclient': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates\\webclient'], 'evennia.web.templates.website': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates\\website'], 'evennia.web.templates.website.flatpages': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates\\website\\flatpages'], 'evennia.web.templates.website.homepage': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates\\website\\homepage'], 'evennia.web.templates.website.registration': ['D:\\Documents\\Python Projects\\evennia_05\\evennia\\evennia\\web\\templates\\website\\registration']}
PATH_PLACEHOLDER = '__editable__.evennia-4.1.1.finder' + ".__path_hook__"


class _EditableFinder:  # MetaPathFinder
    @classmethod
    def find_spec(cls, fullname, path=None, target=None):
        extra_path = []

        # Top-level packages and modules (we know these exist in the FS)
        if fullname in MAPPING:
            pkg_path = MAPPING[fullname]
            return cls._find_spec(fullname, Path(pkg_path))

        # Handle immediate children modules (required for namespaces to work)
        # To avoid problems with case sensitivity in the file system we delegate
        # to the importlib.machinery implementation.
        parent, _, child = fullname.rpartition(".")
        if parent and parent in MAPPING:
            return PathFinder.find_spec(fullname, path=[MAPPING[parent], *extra_path])

        # Other levels of nesting should be handled automatically by importlib
        # using the parent path.
        return None

    @classmethod
    def _find_spec(cls, fullname, candidate_path):
        init = candidate_path / "__init__.py"
        candidates = (candidate_path.with_suffix(x) for x in module_suffixes())
        for candidate in chain([init], candidates):
            if candidate.exists():
                return spec_from_file_location(fullname, candidate)


class _EditableNamespaceFinder:  # PathEntryFinder
    @classmethod
    def _path_hook(cls, path):
        if path == PATH_PLACEHOLDER:
            return cls
        raise ImportError

    @classmethod
    def _paths(cls, fullname):
        # Ensure __path__ is not empty for the spec to be considered a namespace.
        return NAMESPACES[fullname] or MAPPING.get(fullname) or [PATH_PLACEHOLDER]

    @classmethod
    def find_spec(cls, fullname, target=None):
        if fullname in NAMESPACES:
            spec = ModuleSpec(fullname, None, is_package=True)
            spec.submodule_search_locations = cls._paths(fullname)
            return spec
        return None

    @classmethod
    def find_module(cls, fullname):
        return None


def install():
    if not any(finder == _EditableFinder for finder in sys.meta_path):
        sys.meta_path.append(_EditableFinder)

    if not NAMESPACES:
        return

    if not any(hook == _EditableNamespaceFinder._path_hook for hook in sys.path_hooks):
        # PathEntryFinder is needed to create NamespaceSpec without private APIS
        sys.path_hooks.append(_EditableNamespaceFinder._path_hook)
    if PATH_PLACEHOLDER not in sys.path:
        sys.path.append(PATH_PLACEHOLDER)  # Used just to trigger the path hook
